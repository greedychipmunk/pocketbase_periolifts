/// <reference path="../pb_data/types.d.ts" />

migrate((app) => {
  // Create or modify the users auth collection
  const collection = new Collection({
    "id": "",
    "name": "users", 
    "type": "auth",
    "system": false,
    "schema": [
      {
        "name": "name",
        "type": "text",
        "required": true,
        "options": {}
      },
      {
        "name": "username", 
        "type": "text",
        "required": true,
        "options": {}
      },
      {
        "name": "avatar_url",
        "type": "url",
        "required": false,
        "options": {}
      },
      {
        "name": "preferred_units",
        "type": "select",
        "required": false,
        "options": {
          "values": ["metric", "imperial"]
        }
      },
      {
        "name": "preferred_theme",
        "type": "select", 
        "required": false,
        "options": {
          "values": ["light", "dark", "system"]
        }
      },
      {
        "name": "timezone",
        "type": "text",
        "required": false,
        "options": {}
      },
      {
        "name": "onboarding_completed",
        "type": "bool",
        "required": false,
        "options": {}
      },
      {
        "name": "fitness_goals",
        "type": "json",
        "required": false,
        "options": {}
      },
      {
        "name": "current_cycle_phase",
        "type": "text",
        "required": false,
        "options": {}
      },
      {
        "name": "average_cycle_length",
        "type": "number",
        "required": false,
        "options": {}
      },
      {
        "name": "birth_date",
        "type": "date",
        "required": false,
        "options": {}
      },
      {
        "name": "height",
        "type": "number",
        "required": false,
        "options": {}
      },
      {
        "name": "weight",
        "type": "number",
        "required": false,
        "options": {}
      },
      {
        "name": "activity_level",
        "type": "select",
        "required": false,
        "options": {
          "values": [
            "sedentary",
            "lightly_active", 
            "moderately_active",
            "very_active",
            "extremely_active"
          ]
        }
      },
      {
        "name": "notifications_enabled",
        "type": "bool",
        "required": false,
        "options": {}
      },
      {
        "name": "workout_reminders_enabled",
        "type": "bool",
        "required": false,
        "options": {}
      },
      {
        "name": "period_reminders_enabled",
        "type": "bool",
        "required": false,
        "options": {}
      },
      {
        "name": "subscription_status",
        "type": "select",
        "required": false,
        "options": {
          "values": ["free", "premium"]
        }
      },
      {
        "name": "subscription_expires_at",
        "type": "date",
        "required": false,
        "options": {}
      },
      {
        "name": "role",
        "type": "select",
        "required": false,
        "options": {
          "values": ["user", "admin"]
        }
      },
      {
        "name": "is_active",
        "type": "bool",
        "required": false,
        "options": {}
      },
      {
        "name": "last_active_at",
        "type": "date",
        "required": false,
        "options": {}
      }
    ],
    "listRule": "id = @request.auth.id",
    "viewRule": "id = @request.auth.id",
    "createRule": "",
    "updateRule": "id = @request.auth.id",
    "deleteRule": "id = @request.auth.id"
  })

  return app.save(collection)
}, (app) => {
  // Down migration - remove users collection
  const collection = app.findCollectionByNameOrId("users")
  return app.delete(collection)
})